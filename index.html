<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üéÆ AR Monster Party - iOS Ready! üéÉ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëæ</text></svg>">
    <link rel="apple-touch-icon" href="./icon.png">

    <!-- A-Frame + MindAR (iOS-–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è) -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Comic Neue', cursive; touch-action: manipulation; }
        
        /* –ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–µ –≤—ñ–¥–µ–æ */
        #videoBackground {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;
            transform: translateZ(0); -webkit-transform: translateZ(0);
        }
        
        a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent !important; }

        /* UI */
        #gameUI { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #scorePanel, #funCounter { position: absolute; top: env(safe-area-inset-top, 20px); padding: 15px; background: rgba(0,0,0,0.7); color: #FFD166; border-radius: 20px; font-weight: bold; backdrop-filter: blur(10px); font-size: 1.3em; }
        #scorePanel { left: 20px; }
        #funCounter { right: 20px; color: #06D6A0; }

        #instructions {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: white; padding: 25px; border-radius: 20px; text-align: center;
            max-width: 300px; backdrop-filter: blur(15px); border: 2px solid #FFD166;
            font-size: 1.2em; line-height: 1.5;
        }

        .gameBtn {
            position: absolute; bottom: max(20px, env(safe-area-inset-bottom, 20px)); left: 50%; transform: translateX(-50%);
            background: linear-gradient(45deg, #FF6F61, #FF9E6D); color: white; border: none; border-radius: 50px;
            padding: 16px 32px; font-size: 1.3em; font-weight: bold; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            pointer-events: auto; min-width: 200px; backdrop-filter: blur(10px);
        }
        .gameBtn:active { transform: translateX(-50%) scale(0.95); }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó —Ç–∞ –µ—Ñ–µ–∫—Ç–∏ ‚Äî –±–µ–∑ –∑–º—ñ–Ω */
        .tap-icon { /* ... –≤–∞—à—ñ —Å—Ç–∏–ª—ñ ... */ }
        /* ... —Ä–µ—à—Ç–∞ —Å—Ç–∏–ª—ñ–≤ –±–µ–∑ –∑–º—ñ–Ω ... */
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <video id="videoBackground" playsinline muted loop webkit-playsinline></video>

    <div id="gameUI">
        <div id="scorePanel">üç¨ Candy: <span id="score">0</span></div>
        <div id="funCounter">üéâ Fun: <span id="taps">0</span></div>
        <div id="instructions">
            <div style="font-size: 2em; margin-bottom: 10px;">üéÉ</div>
            <div>Find Halloween monsters!</div>
            <div style="color: #FFD166; margin-top: 10px; font-size: 0.9em;">
                Tap them for candy & spooky sounds!
            </div>
            <div style="color: #06D6A0; margin-top: 15px; font-size: 0.8em;">
                Works best in Safari! üì±
            </div>
        </div>
        <button id="startBtn" class="gameBtn">üéÆ Start Monster Party!</button>
        <button id="endBtn" class="gameBtn" style="display: none;">üèÅ Finish Game</button>
    </div>

    <a-scene
        mindar-image="imageTargetSrc: https://yourdomain.com/7-targets.mind; filterMinCF: 0.0001; filterBeta: 0.001; warmupTolerance: 3; autoStart: false;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
        embedded
        webxr="optionalFeatures: hit-test; requiredFeatures: dom-overlay; overlayElement: #gameUI;"
    >
        <a-assets timeout="60000">
            <audio id="bg-music" src="https://yourdomain.com/bg-music.mp3" preload="auto"></audio>
            <!-- –ó–≤—É–∫–∏ –º–æ–Ω—Å—Ç—Ä—ñ–≤ -->
            <audio id="boo1" src="https://yourdomain.com/boo1.mp3" preload="auto"></audio>
            <!-- ... —ñ–Ω—à—ñ –∑–≤—É–∫–∏ ... -->
            <!-- –õ–æ–≥–æ—Ç–∏–ø–∏ -->
            <img id="logo1" src="https://yourdomain.com/logo1.png" crossorigin="anonymous">
            <!-- ... —ñ–Ω—à—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ... -->
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

        <!-- –ú–æ–Ω—Å—Ç—Ä–∏ (–±–µ–∑ –∑–º—ñ–Ω) -->
        <!-- ... –≤–∞—à—ñ a-entity ... -->
    </a-scene>

    <script>
        // === iOS-–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π —Å—Ç–∞—Ä—Ç ===
        let userInteracted = false;
        let audioContextUnlocked = false;

        // –†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ —Ç–∞–ø—É
        function unlockAudio() {
            if (audioContextUnlocked) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                audioContextUnlocked = true;
                console.log("Audio unlocked");
            });
        }

        // –ü–æ—á–∞—Ç–æ–∫ –≥—Ä–∏
        document.getElementById('startBtn').addEventListener('click', async () => {
            userInteracted = true;
            unlockAudio();
            await startGame();
        });

        document.getElementById('endBtn').addEventListener('click', endGame);

        async function startGame() {
            if (!userInteracted) return;

            // –ö–∞–º–µ—Ä–∞
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                const video = document.getElementById('videoBackground');
                video.srcObject = stream;
                video.play();

                // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('endBtn').style.display = 'block';

                // –ó–∞–ø—É—Å–∫ AR
                const scene = document.querySelector('a-scene');
                const mindar = scene.systems['mindar-image-system'];
                if (mindar) mindar.start();

                // –§–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞
                const bgMusic = document.getElementById('bg-music');
                bgMusic.volume = 0.1;
                bgMusic.loop = true;
                bgMusic.play().catch(() => {});

            } catch (err) {
                alert("Camera access denied. Please allow camera in Safari settings.");
                console.error(err);
            }
        }

        function endGame() {
            const mindar = document.querySelector('a-scene')?.systems['mindar-image-system'];
            if (mindar) mindar.stop();

            const video = document.getElementById('videoBackground');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }

            showFinalCelebration();
        }

        function showFinalCelebration() {
            alert(`üéä PARTY OVER! üéä\n\nüç¨ Candies: ${gameState.score}\nüéâ Taps: ${gameState.totalTaps}\n\nThanks for playing! üëª`);
            location.reload();
        }

        // === –†–µ—à—Ç–∞ –ª–æ–≥—ñ–∫–∏ –≥—Ä–∏ (–±–µ–∑ –∑–º—ñ–Ω) ===
        // ... –≤–∞—à –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π JS-–∫–æ–¥ (handleMonsterTap, createClickEffect —Ç–æ—â–æ) ...

        // –î–æ–¥–∞–π—Ç–µ —Ü–µ–π —Ä—è–¥–æ–∫ –≤ –∫—ñ–Ω–µ—Ü—å:
        document.body.addEventListener('touchstart', unlockAudio, { once: true });
    </script>
</body>
</html>
