<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AR Monster Party - iOS Ready!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <link rel="apple-touch-icon" href="./icon.png">

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Comic Neue', cursive; touch-action: manipulation; }
        
        #videoBackground {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;
            transform: translateZ(0); -webkit-transform: translateZ(0);
        }
        
        a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent !important; }

        #gameUI { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #scorePanel, #funCounter {
            position: absolute; top: env(safe-area-inset-top, 20px); padding: 15px;
            background: rgba(0,0,0,0.7); border-radius: 20px; font-weight: bold; backdrop-filter: blur(10px); font-size: 1.3em;
        }
        #scorePanel { left: 20px; color: #FFD166; }
        #funCounter { right: 20px; color: #06D6A0; }

        #instructions {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: white; padding: 25px; border-radius: 20px; text-align: center;
            max-width: 300px; backdrop-filter: blur(15px); border: 2px solid #FFD166; font-size: 1.2em; line-height: 1.5;
        }

        .gameBtn {
            position: absolute; bottom: max(20px, env(safe-area-inset-bottom, 20px)); left: 50%; transform: translateX(-50%);
            background: linear-gradient(45deg, #FF6F61, #FF9E6D); color: white; border: none; border-radius: 50px;
            padding: 16px 32px; font-size: 1.3em; font-weight: bold; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            pointer-events: auto; min-width: 200px; backdrop-filter: blur(10px);
        }
        .gameBtn:active { transform: translateX(-50%) scale(0.95); }

        /* Monster icons */
        .tap-icon {
            position: absolute; width: 70px; height: 70px; background: rgba(255,255,255,0.95); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.8em; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            cursor: pointer; pointer-events: auto; z-index: 20; border: 3px solid; animation: floatTap 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        .tap-icon-0 { border-color: #FF6F61; background: rgba(255,111,97,0.9); }
        .tap-icon-1 { border-color: #FFD166; background: rgba(255,209,102,0.9); }
        .tap-icon-2 { border-color: #06D6A0; background: rgba(6,214,160,0.9); }
        .tap-icon-3 { border-color: #118AB2; background: rgba(17,138,178,0.9); }
        .tap-icon-4 { border-color: #EF476F; background: rgba(239,71,111,0.9); }
        .tap-icon-5 { border-color: #9B5DE5; background: rgba(155,93,229,0.9); }
        .tap-icon-6 { border-color: #00BBF9; background: rgba(0,187,249,0.9); }
        .tap-icon:hover { transform: scale(1.2) rotate(10deg); }

        /* Click effects */
        .click-effect {
            position: absolute; width: 80px; height: 80px; border-radius: 50%; pointer-events: none; z-index: 100;
            animation: clickAnim 0.8s ease-out forwards;
        }
        .click-effect-0 { background: radial-gradient(circle, rgba(255,111,97,0.8) 0%, rgba(255,111,97,0) 70%); }
        .click-effect-1 { background: radial-gradient(circle, rgba(255,209,102,0.8) 0%, rgba(255,209,102,0) 70%); }
        .click-effect-2 { background: radial-gradient(circle, rgba(6,214,160,0.8) 0%, rgba(6,214,160,0) 70%); }
        .click-effect-3 { background: radial-gradient(circle, rgba(17,138,178,0.8) 0%, rgba(17,138,178,0) 70%); }
        .click-effect-4 { background: radial-gradient(circle, rgba(239,71,111,0.8) 0%, rgba(239,71,111,0) 70%); }
        .click-effect-5 { background: radial-gradient(circle, rgba(155,93,229,0.8) 0%, rgba(155,93,229,0) 70%); }
        .click-effect-6 { background: radial-gradient(circle, rgba(0,187,249,0.8) 0%, rgba(0,187,249,0) 70%); }

        @keyframes clickAnim { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        @keyframes floatTap { 0%, 100% { transform: translateY(0) rotate(0deg) scale(1); } 25% { transform: translateY(-15px) rotate(-5deg) scale(1.05); } 50% { transform: translateY(-20px) rotate(5deg) scale(1.1); } 75% { transform: translateY(-10px) rotate(-3deg) scale(1.05); } }
        @keyframes monsterDance { 0% { transform: scale(1) rotate(0deg) translateY(0); } 25% { transform: scale(1.2) rotate(-10deg) translateY(-10px); } 50% { transform: scale(1.3) rotate(10deg) translateY(-15px); } 75% { transform: scale(1.1) rotate(-5deg) translateY(-5px); } 100% { transform: scale(1) rotate(0deg) translateY(0); } }
        .monster-dance { animation: monsterDance 1s ease; }
        .active-monster { filter: drop-shadow(0 0 15px gold) brightness(1.3); }

        .celebration { position: absolute; font-size: 2em; font-weight: bold; z-index: 50; pointer-events: none; animation: celebrate 2s ease-out forwards; }
        @keyframes celebrate { 0% { transform: translateY(0) scale(0); opacity: 0; } 20% { transform: translateY(-50px) scale(1.2); opacity: 1; } 80% { transform: translateY(-150px) scale(1); opacity: 1; } 100% { transform: translateY(-200px) scale(0.8); opacity: 0; } }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <video id="videoBackground" playsinline muted loop webkit-playsinline></video>

    <div id="gameUI">
        <div id="scorePanel">Candy: <span id="score">0</span></div>
        <div id="funCounter">Fun: <span id="taps">0</span></div>
        <div id="instructions">
            <div style="font-size: 2em; margin-bottom: 10px;"></div>
            <div>Find Halloween monsters!</div>
            <div style="color: #FFD166; margin-top: 10px; font-size: 0.9em;">Tap them for candy & spooky sounds!</div>
            <div style="color: #06D6A0; margin-top: 15px; font-size: 0.8em;">Works best in Safari!</div>
        </div>
        <button id="startBtn" class="gameBtn">Start Monster Party!</button>
        <button id="endBtn" class="gameBtn" style="display: none;">Finish Game</button>
    </div>

    <a-scene
        mindar-image="imageTargetSrc: ./7-targets.mind; filterMinCF: 0.0001; filterBeta: 0.001; warmupTolerance: 3; autoStart: false;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
        embedded
        webxr="optionalFeatures: hit-test; requiredFeatures: dom-overlay; overlayElement: #gameUI;"
    >
        <a-assets timeout="60000">
            <audio id="bg-music" src="./bg-music.mp3" preload="auto"></audio>
            <audio id="boo1" src="./boo1.mp3" preload="auto"></audio>
            <audio id="boo2" src="./boo2.mp3" preload="auto"></audio>
            <audio id="boo3" src="./boo3.mp3" preload="auto"></audio>
            <audio id="boo4" src="./boo4.mp3" preload="auto"></audio>
            <audio id="boo5" src="./boo5.mp3" preload="auto"></audio>
            <audio id="boo6" src="./boo6.mp3" preload="auto"></audio>
            <audio id="boo7" src="./boo7.mp3" preload="auto"></audio>

            <img id="logo1" src="./logo1.png" crossorigin="anonymous">
            <img id="logo2" src="./logo2.png" crossorigin="anonymous">
            <img id="logo3" src="./logo3.png" crossorigin="anonymous">
            <img id="logo4" src="./logo4.png" crossorigin="anonymous">
            <img id="logo5" src="./logo5.png" crossorigin="anonymous">
            <img id="logo6" src="./logo6.png" crossorigin="anonymous">
            <img id="logo7" src="./logo7.png" crossorigin="anonymous">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

        <!-- 7 Monsters -->
        <a-entity mindar-image-target="targetIndex: 0" class="monster-target">
            <a-image src="#logo1" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo1">
                <a-animation attribute="rotation" to="0 360 0" dur="6000" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="position" to="0 0.1 0" dur="2000" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 1" class="monster-target">
            <a-image src="#logo2" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo2">
                <a-animation attribute="rotation" to="360 0 0" dur="5000" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="scale" to="1.2 1.2 1.2" dur="1500" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 2" class="monster-target">
            <a-image src="#logo3" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo3">
                <a-animation attribute="rotation" to="0 0 360" dur="4000" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="position" to="0.1 0 0" dur="1800" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 3" class="monster-target">
            <a-image src="#logo4" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo4">
                <a-animation attribute="rotation" to="0 360 360" dur="7000" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="scale" to="0.8 0.8 0.8" dur="2200" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 4" class="monster-target">
            <a-image src="#logo5" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo5">
                <a-animation attribute="rotation" to="360 360 0" dur="5500" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="position" to="0 0.15 0" dur="2500" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 5" class="monster-target">
            <a-image src="#logo6" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo6">
                <a-animation attribute="rotation" to="0 180 360" dur="6500" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="scale" to="1.3 1.3 1.3" dur="1900" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 6" class="monster-target">
            <a-image src="#logo7" position="0 0 0" scale="1 1 1" class="clickable-monster" data-sound="boo7">
                <a-animation attribute="rotation" to="360 0 360" dur="4800" repeat="indefinite" easing="linear"></a-animation>
                <a-animation attribute="position" to="-0.1 0.1 0" dur="2100" repeat="indefinite" direction="alternate" easing="easeInOutSine"></a-animation>
            </a-image>
        </a-entity>
    </a-scene>

    <script>
        const gameState = {
            score: 0, totalTaps: 0, gameActive: false, activeMonsters: new Map(),
            monsterSounds: ['boo1','boo2','boo3','boo4','boo5','boo6','boo7'],
            monsterNames: ['Spooky Ghost','Funny Pumpkin','Green Monster','Blue Creature','Pink Phantom','Purple Beast','Blue Wizard'],
            monsterColors: ['#FF6F61','#FFD166','#06D6A0','#118AB2','#EF476F','#9B5DE5','#00BBF9']
        };

        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const scoreDisplay = document.getElementById('score');
        const tapsDisplay = document.getElementById('taps');
        const instructions = document.getElementById('instructions');
        const videoBackground = document.getElementById('videoBackground');
        let userInteracted = false;

        function unlockAudio() {
            if (userInteracted) return;
            userInteracted = true;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume();
            const sounds = document.querySelectorAll('audio');
            sounds.forEach(s => { s.play().catch(()=>{}); s.pause(); s.currentTime = 0; });
        }

        startBtn.addEventListener('click', async () => {
            unlockAudio();
            await startGame();
        });
        endBtn.addEventListener('click', endGame);
        document.body.addEventListener('touchstart', unlockAudio, { once: true });

        async function startGame() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                videoBackground.srcObject = stream;
                videoBackground.play();

                instructions.style.display = 'none';
                startBtn.style.display = 'none';
                endBtn.style.display = 'block';

                const scene = document.querySelector('a-scene');
                const mindar = scene.systems['mindar-image-system'];
                if (mindar) mindar.start();

                const bgMusic = document.getElementById('bg-music');
                bgMusic.volume = 0.1; bgMusic.loop = true; bgMusic.play().catch(()=>{});

            } catch (err) {
                alert("Camera access denied. Please allow in Safari settings.");
                console.error(err);
            }
        }

        function endGame() {
            const mindar = document.querySelector('a-scene')?.systems['mindar-image-system'];
            if (mindar) mindar.stop();
            if (videoBackground.srcObject) videoBackground.srcObject.getTracks().forEach(t => t.stop());
            alert(`PARTY OVER!\n\nCandies: ${gameState.score}\nTaps: ${gameState.totalTaps}\n\nThanks for playing!`);
            location.reload();
        }

        document.querySelector('a-scene').addEventListener('loaded', () => {
            const targets = document.querySelectorAll('a-entity[mindar-image-target]');
            targets.forEach((target, index) => {
                let tapIcon = null;
                target.addEventListener('targetFound', () => {
                    if (!gameState.gameActive) return;
                    const monsterImg = target.querySelector('a-image');
                    if (monsterImg && !gameState.activeMonsters.has(index)) {
                        createTapIcon(target, index);
                        monsterImg.classList.add('active-monster');
                    }
                });
                target.addEventListener('targetLost', () => {
                    if (tapIcon) { tapIcon.remove(); gameState.activeMonsters.delete(index); }
                    target.querySelector('a-image')?.classList.remove('active-monster');
                });
                target.querySelector('a-image').addEventListener('click', (e) => {
                    if (gameState.gameActive) handleMonsterTap(target, index, e);
                });
            });
        });

        function createTapIcon(target, idx) {
            const tapIcon = document.createElement('div');
            tapIcon.className = `tap-icon tap-icon-${idx}`;
            const emojis = ['', '', '', '', '', '', ''];
            tapIcon.innerHTML = emojis[idx];
            const pos = [
                {left:'10%',top:'20%'}, {left:'80%',top:'25%'}, {left:'15%',top:'70%'},
                {left:'75%',top:'65%'}, {left:'45%',top:'15%'}, {left:'55%',top:'75%'}, {left:'25%',top:'45%'}
            ][idx];
            tapIcon.style.left = pos.left; tapIcon.style.top = pos.top;
            document.getElementById('gameUI').appendChild(tapIcon);
            gameState.activeMonsters.set(idx, tapIcon);
            tapIcon.addEventListener('click', (e) => { e.stopPropagation(); handleMonsterTap(target, idx, e); });
        }

        function handleMonsterTap(target, idx, e) {
            if (!gameState.gameActive) return;
            const monsterImg = target.querySelector('a-image');
            if (e) createClickEffect(e.clientX, e.clientY, idx);
            monsterImg.classList.add('monster-dance');
            setTimeout(() => monsterImg.classList.remove('monster-dance'), 1000);
            playSound(gameState.monsterSounds[idx]);
            const points = 10 + idx * 2;
            gameState.score += points; gameState.totalTaps++;
            scoreDisplay.textContent = gameState.score; tapsDisplay.textContent = gameState.totalTaps;
            showPointsPopup(`+${points}`, e?.clientX || innerWidth/2, e?.clientY || innerHeight/2, idx);
            if (gameState.totalTaps % 25 === 0) showCelebration('AWESOME!', idx);
        }

        function createClickEffect(x, y, idx) {
            const effect = document.createElement('div');
            effect.className = `click-effect click-effect-${idx}`;
            effect.style.left = `${x-40}px`; effect.style.top = `${y-40}px`;
            document.getElementById('gameUI').appendChild(effect);
            setTimeout(() => effect.remove(), 800);
        }

        function showPointsPopup(text, x, y, idx) {
            const popup = document.createElement('div');
            popup.textContent = text; popup.style.position = 'absolute'; popup.style.left = `${x}px`; popup.style.top = `${y}px`;
            popup.style.color = gameState.monsterColors[idx]; popup.style.fontSize = '1.8em'; popup.style.fontWeight = 'bold';
            popup.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)'; popup.style.zIndex = '100'; popup.style.pointerEvents = 'none';
            const style = document.createElement('style');
            style.textContent = `@keyframes floatUp {0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80px) scale(1.3);opacity:0}}`;
            document.head.appendChild(style);
            popup.style.animation = 'floatUp 1s ease-out forwards';
            document.getElementById('gameUI').appendChild(popup);
            setTimeout(() => { popup.remove(); style.remove(); }, 1000);
        }

        function showCelebration(text, idx) {
            const c = document.createElement('div');
            c.className = 'celebration'; c.textContent = text; c.style.color = gameState.monsterColors[idx];
            c.style.left = `${Math.random() * 70 + 15}%`; c.style.top = '80%';
            document.getElementById('gameUI').appendChild(c);
            setTimeout(() => c.remove(), 2000);
        }

        function playSound(id) {
            const sound = document.getElementById(id);
            if (sound) { sound.currentTime = 0; sound.volume = 0.7; sound.play().catch(() => {}); }
        }

        // Start game flag
        document.getElementById('startBtn').addEventListener('click', () => {
            gameState.gameActive = true;
        });
    </script>
</body>
</html>
